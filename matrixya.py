import subprocess
import time
import threading
from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import logging
import requests
from yandex_chain import YandexLLM, YandexEmbeddings, YandexGPTModel
from langchain_community.vectorstores import InMemoryVectorStore
from langchain.prompts import ChatPromptTemplate
from langchain.schema.output_parser import StrOutputParser
from langchain.schema import Document
from textblob import TextBlob  # –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
import os 

# --- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ---
logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s]: %(message)s")
logger = logging.getLogger(__name__)

# --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
IAM_TOKEN = None
STATIC_BEARER_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJZCI6IjVkY2Q0M2VkLTZlYjAtNGEwMS04NWY0LTI4ZTNiMTBkNWE4OCIsIk5hbWUiOiLQrdGA0LjQuiIsIlN1cm5hbWUiOiLQkNC90LTRgNC40Y_QvdC-0LIiLCJSb2xlTmFtZSI6ItCQ0LTQvNC40L3QuNGB0YLRgNCw0YLQvtGAIiwiRW1haWwiOiJ4em9sZW5yNkBnbWFpbC5jb20iLCJUZW5hbnRJZCI6Im1lZHl1bWVkLjIwMjMtMDQtMjQiLCJSb2xlSWQiOiJyb2xlMiIsIlBob3RvVXJsIjoiIiwiQ2l0eUlkIjoiMCIsIlBob25lTnVtYmVyIjoiIiwiRmF0aGVyTmFtZSI6ItGC0LXRgdGCIiwiUG9zaXRpb25JZCI6ImUxNTg5OWJkLTYyYTQtNDNkZi1hMWZlLWVlNDBjNGQ0NmY0YSIsImV4cCI6MTczNTE0NTcyOSwiaXNzIjoiaHR0cHM6Ly9sb2NhbGhvc3Q6NzA5NSIsImF1ZCI6Imh0dHBzOi8vbG9jYWxob3N0OjcwOTUifQ.eZFoFxAXgYWzQzEMzae8zxZrzXbiFP3fEOdgNTSzI30"
API_URL_SERVICES = "https://dev.back.matrixcrm.ru/api/v1/AI/servicesByFilters"
API_URL_CLIENT = "https://dev.back.matrixcrm.ru/api/v1/Client/elasticByPhone"  # API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
FOLDER_ID = "b1gb9k14k5ui80g91tnp"
YANDEX_SLEEP_INTERVAL = 0.1
YANDEX_MODEL = YandexGPTModel.ProRC

# --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IAM —Ç–æ–∫–µ–Ω–∞ ---
def update_iam_token():
    global IAM_TOKEN
    try:
        logger.info("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IAM —Ç–æ–∫–µ–Ω–∞...")
        result = subprocess.run(
            ["yc", "iam", "create-token"],
            capture_output=True, text=True, check=True
        )
        IAM_TOKEN = result.stdout.strip()
        logger.info("IAM —Ç–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω.")
    except subprocess.CalledProcessError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ IAM —Ç–æ–∫–µ–Ω–∞: {e.stderr}")
        IAM_TOKEN = None
    except Exception as e:
        logger.error(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ IAM —Ç–æ–∫–µ–Ω–∞: {e}")
        IAM_TOKEN = None

def start_token_updater():
    def updater():
        while True:
            update_iam_token()  # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω
            time.sleep(12 * 60 * 60)  # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–∫–µ–Ω –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤

    thread = threading.Thread(target=updater, daemon=True)
    thread.start()
    logger.info("–§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IAM —Ç–æ–∫–µ–Ω–∞ –∑–∞–ø—É—â–µ–Ω.")

# --- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ---
def get_user_info(phone_number: str):
    """
    –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    :param phone_number: –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    :return: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
    """
    headers = {"Authorization": f"Bearer {STATIC_BEARER_TOKEN}", "accept": "*/*"}
    params = {"content": phone_number}
    try:
        response = requests.post(API_URL_CLIENT, headers=headers, params=params)
        response.raise_for_status()
        user_data = response.json()["data"][0]
        return {
            "name": user_data.get("name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"),
            "surname": user_data.get("surname", ""),
            "full_name": user_data.get("fullName", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"),
            "phone": phone_number,
            "gender": "–∂–µ–Ω—â–∏–Ω–∞" if user_data.get("genderId") == 6 else "–º—É–∂—á–∏–Ω–∞",
            "categories": [category["name"] for category in user_data.get("listCategories", [])]
        }
    except requests.exceptions.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return {"name": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "gender": "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", "phone": phone_number}

# --- –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è ---
def analyze_user_mood(query: str) -> str:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    :param query: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    :return: –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ("—Ö–æ—Ä–æ—à–µ–µ", "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ", "–ø–ª–æ—Ö–æ–µ").
    """
    analysis = TextBlob(query)
    polarity = analysis.sentiment.polarity
    if polarity > 0.2:
        return "—Ö–æ—Ä–æ—à–µ–µ"
    elif polarity < -0.2:
        return "–ø–ª–æ—Ö–æ–µ"
    else:
        return "–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ"

# --- –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API —É—Å–ª—É–≥ ---
def get_context_from_api(user_gender: str):
    try:
        logger.info("–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ API...")
        headers = {"Authorization": f"Bearer {STATIC_BEARER_TOKEN}"}
        response = requests.get(API_URL_SERVICES, headers=headers)
        if response.status_code != 200:
            raise HTTPException(status_code=response.status_code, detail="–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö API.")

        data = response.json()
        items = data.get("data", {}).get("items", [])
        services = []

        for item in items:
            service_name = item.get("serviceName")
            category = item.get("categoryName", "–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–∏")
            price = f"{item.get('price', 0)} —Ä—É–±."
            filial = item.get("filialName", "–§–∏–ª–∏–∞–ª –Ω–µ —É–∫–∞–∑–∞–Ω")
            specialist = item.get("employeeFullName", "").strip() or "–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –Ω–µ —É–∫–∞–∑–∞–Ω"
            gender_restriction = item.get("genderRestriction", "all")

            if (user_gender == "–º—É–∂—á–∏–Ω–∞" and gender_restriction == "–∂–µ–Ω—â–∏–Ω–∞") or \
               (user_gender == "–∂–µ–Ω—â–∏–Ω–∞" and gender_restriction == "–º—É–∂—á–∏–Ω–∞"):
                continue

            if service_name:
                service_entry = f"{service_name}, –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}, –¶–µ–Ω–∞: {price}, –§–∏–ª–∏–∞–ª: {filial}, –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: {specialist}"
                services.append(Document(page_content=service_entry))

        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ {len(services)} —É—Å–ª—É–≥ –∏–∑ API –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.")
        return services
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ API: {e}")
        return [Document(page_content="–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ API.")]
    
    
import os

def load_prompt_template(file_name: str) -> str:
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—Å—Ç —à–∞–±–ª–æ–Ω–∞ –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.
    :param file_name: –ò–º—è —Ñ–∞–π–ª–∞ —Å —à–∞–±–ª–æ–Ω–æ–º.
    :return: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏.
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        file_path = os.path.join(os.getcwd(), file_name)
        with open(file_path, "r", encoding="utf-8") as file:
            return file.read()
    except FileNotFoundError:
        raise RuntimeError(f"–§–∞–π–ª —à–∞–±–ª–æ–Ω–∞ {file_name} –Ω–µ –Ω–∞–π–¥–µ–Ω.")
    except Exception as e:
        raise RuntimeError(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {file_name}: {str(e)}")

# --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ Yandex GPT ---
def process_query(query: str, phone_number: str):
    logger.info("–ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞...")

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user_info = get_user_info(phone_number)
    user_gender = user_info.get("gender", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    user_mood = analyze_user_mood(query)  # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ LLM –∏ embeddings
    embeddings = YandexEmbeddings(folder_id=FOLDER_ID, iam_token=IAM_TOKEN, sleep_interval=YANDEX_SLEEP_INTERVAL)
    llm = YandexLLM(folder_id=FOLDER_ID, iam_token=IAM_TOKEN, model=YANDEX_MODEL)

    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ API
    docs = get_context_from_api(user_gender=user_gender)
    vectorstore = InMemoryVectorStore.from_documents(docs, embedding=embeddings)
    retriever = vectorstore.as_retriever()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
    retrieved_docs = retriever.invoke(query)
    context = "\n".join([doc.page_content for doc in retrieved_docs])

    # –ü—Ä–æ–º–ø—Ç —Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    template = """
    –¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—Å—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω—ã–π –¥–∏–∞–ª–æ–≥. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Ä–∞–∑–Ω—ã—Ö –æ–±–ª–∞—Å—Ç—è—Ö –±–∏–∑–Ω–µ—Å–∞, –ø–æ—ç—Ç–æ–º—É —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–º–∏, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç–∏–ø—ã –±–∏–∑–Ω–µ—Å–∞, –≤–∫–ª—é—á–∞—è —Å—Ñ–µ—Ä—É —É—Å–ª—É–≥, –ø—Ä–æ–¥–∞–∂, –º–µ–¥–∏—Ü–∏–Ω—ã, –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ –º–Ω–æ–≥–∏–µ –¥—Ä—É–≥–∏–µ.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É —Å –ª—é–±—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è —Ç–æ—á–Ω—É—é –∏ –ø–æ–Ω—è—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –¢—ã —Å–ª–µ–¥—É–µ—à—å –≤–∞–∂–Ω—ã–º –ø—Ä–∏–Ω—Ü–∏–ø–∞–º –≤ –æ–±—â–µ–Ω–∏–∏, —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –∫–ª–∏–µ–Ω—Ç–∞ –∏ —Å–æ–∑–¥–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –¥–æ–≤–µ—Ä–∏—è –∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è.

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —Ä–∞–±–æ—Ç—ã:
1. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –±–∏–∑–Ω–µ—Å**:
   –¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –∫–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏. –¢—ã —É—á–∏—Ç—ã–≤–∞–µ—à—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—à—å —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º –±–∏–∑–Ω–µ—Å–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å. –ù–∞–ø—Ä–∏–º–µ—Ä, –≤ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —É—á—Ä–µ–∂–¥–µ–Ω–∏—è—Ö —Ç—ã –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—à—å—Å—è –Ω–∞ —É—Å–ª—É–≥–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ –∑–¥–æ—Ä–æ–≤—å–µ–º, –∞ –≤ —Å—Ñ–µ—Ä–µ —É—Å–ª—É–≥ ‚Äî –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∏ —Ü–µ–Ω—ã.

2. **–£—á–µ—Ç –ø–æ–ª–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞**:
   –¢—ã –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—à—å –≤–æ –≤–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥. –¢—ã —Ñ–∏–ª—å—Ç—Ä—É–µ—à—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –ø—Ä–µ–¥–ª–∞–≥–∞—è —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∑–∞–ø—Ä–æ—Å–∞–º –ø–æ –ø–æ–ª—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É—Å–ª—É–≥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ –¥–ª—è –∂–µ–Ω—â–∏–Ω –∏–ª–∏ –º—É–∂—á–∏–Ω). –ï—Å–ª–∏ —Ç–∞–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –µ—Å—Ç—å, —Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ–æ–±—â–∞–µ—à—å –æ–± —ç—Ç–æ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.

3. **–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è**:
   –¢—ã —É—á–∏—Ç—ã–≤–∞–µ—à—å –ª–∏—á–Ω—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ —Ç–∏–ø –∑–∞–ø—Ä–æ—Å–∞. –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏, —Ç—ã –±—É–¥–µ—à—å –æ–±—â–∞—Ç—å—Å—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —Å —é–º–æ—Ä–æ–º. –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –∏–ª–∏ –ø–ª–æ—Ö–æ–µ ‚Äî —Ç—ã –±—É–¥–µ—à—å —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã–º –∏ —Å–ø–æ–∫–æ–π–Ω—ã–º, –ø—Ä–µ–¥–ª–∞–≥–∞—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å —Ç–∞–∫—Ç–æ–º.

4. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏**:
   –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ç–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –±—ã–ª–∏ –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –∏ –ø–æ–ª–µ–∑–Ω—ã–º–∏, —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ø—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∂–∏–∑–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –ª—É—á—à–µ –ø–æ–Ω—è—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –¢—ã –º–æ–∂–µ—à—å –ø—Ä–∏–≤–µ—Å—Ç–∏ –ø—Ä–∏–º–µ—Ä—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º –∏–ª–∏ —É—Å–ª—É–≥–∞–º –∫–æ–º–ø–∞–Ω–∏–∏, –∞ —Ç–∞–∫–∂–µ –æ–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–Ω—è—Ç–∏–π.

5. **–ó–∞–¥–∞–≤–∞–Ω–∏–µ —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤**:
   –¢—ã –≤—Å–µ–≥–¥–∞ –∑–∞–¥–∞–µ—à—å –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É. –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, –∏–∑–±–µ–≥–∞—è –Ω–µ–¥–æ—Ä–∞–∑—É–º–µ–Ω–∏–π. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ü–µ–Ω–µ, —Ç—ã —É—Ç–æ—á–Ω—è–µ—à—å, –∫–∞–∫—É—é —É—Å–ª—É–≥—É –æ–Ω –∏–º–µ–µ—Ç –≤ –≤–∏–¥—É.

6. **–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–∞—Ö**:
   –ï—Å–ª–∏ —Ç—ã –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å, —Ç—ã —á–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–µ—à—å —ç—Ç–æ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏–ª–∏ –∏–¥–µ–∏ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è. –¢—ã –Ω–µ –¥–∞–µ—à—å –ª–æ–∂–Ω—ã—Ö –æ–±–µ—â–∞–Ω–∏–π –∏ –Ω–µ –ø—ã—Ç–∞–µ—à—å—Å—è –æ–±–º–∞–Ω—É—Ç—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞, –∞ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ —Ä–µ—à–µ–Ω–∏—è.

7. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–≥–æ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–æ–Ω–∞**:
   –¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—à—å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –∫–∞—Å–∞–µ—Ç—Å—è —Å–ª–æ–∂–Ω—ã—Ö –∏–ª–∏ –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã—Ö —Ç–µ–º. –ï—Å–ª–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –≤—ã—Ä–∞–∂–∞–µ—Ç –Ω–µ–¥–æ–≤–æ–ª—å—Å—Ç–≤–æ, —Ç—ã –º—è–≥–∫–æ –∏ —Ç–∞–∫—Ç–∏—á–Ω–æ —É—Å–ø–æ–∫–∞–∏–≤–∞–µ—à—å –µ–≥–æ, –ø—Ä–µ–¥–ª–∞–≥–∞—è —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ–±—Ä–æ—Ç–æ–π –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º. –¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –≤–∞–∂–Ω–æ –Ω–µ —Ç–æ–ª—å–∫–æ –¥–∞—Ç—å –æ—Ç–≤–µ—Ç, –Ω–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –¥–æ–≤–µ—Ä–∏—è –∏ –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç–∏.

8. **–ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—é —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞**:
   –¢—ã –≤—Å–µ–≥–¥–∞ –ø–æ–Ω–∏–º–∞–µ—à—å, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –µ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –æ–±—â–µ–Ω–∏—è. –ü–æ—ç—Ç–æ–º—É —Ç—ã –±—É–¥–µ—à—å:
   - –í —Ö–æ—Ä–æ—à–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω—ã–º, —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —é–º–æ—Ä–∞.
   - –í –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∏ —Å–ø–æ–∫–æ–π–Ω—ã–º.
   - –í –ø–ª–æ—Ö–æ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏: —Ç–∞–∫—Ç–∏—á–Ω—ã–º –∏ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–º, –ø—Ä–µ–¥–ª–∞–≥–∞—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º –∏ —É–≤–∞–∂–µ–Ω–∏–µ–º.

9. **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤**:
   –¢—ã –≤—Å–µ–≥–¥–∞ –æ–±—ä—è—Å–Ω—è–µ—à—å, –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏—è, –∏–∑–±–µ–≥–∞—è –∏–∑–ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ç–∫–æ –∏ –ø–æ —Å—É—â–µ—Å—Ç–≤—É. –ù–∞–ø—Ä–∏–º–µ—Ä:
   - –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ü–µ–Ω–µ, —Ç—ã –¥–∞–µ—à—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∑–∞–ø—Ä–æ—Å—É: "–£—Å–ª—É–≥–∞ X —Å—Ç–æ–∏—Ç Y —Ä—É–±–ª–µ–π."
   - –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º, —Ç—ã –Ω–∞–∑—ã–≤–∞–µ—à—å –∏–º—è –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.
   - –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ —Ñ–∏–ª–∏–∞–ª–∞, —Ç—ã —Ç–æ—á–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—à—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ.

10. **–ö–æ–Ω—Ç–µ–∫—Å—Ç –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö –∏ –æ—Ç–≤–µ—Ç–∞—Ö**:
    –¢—ã —É—á–∏—Ç—ã–≤–∞–µ—à—å –≤—Å–µ –Ω—é–∞–Ω—Å—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –≤ –∫–æ—Ç–æ—Ä–æ–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å. –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ–ø—Ä–æ—Å –æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã, —É—Å–ª—É–≥–∞—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É—Å–ª—É–≥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –∏ –¥—Ä—É–≥–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤. –¢—ã –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥–∏—à—å –∑–∞ —Ç–µ–º, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –∑–∞–ø—Ä–æ—Å—É –∏ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∑–∞ —Ä–∞–º–∫–∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.

### –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏:
- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_name}
- –ü–æ–ª: {user_gender}
- –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: {user_mood}
- –í–æ–ø—Ä–æ—Å: {question}
- –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥: {context}

### –ü—Ä–∏–º–µ—Ä –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ñ—Ä–∞–∑:
- **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ**: "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å–µ–≥–æ–¥–Ω—è? üòä", "–ü—Ä–∏–≤–µ—Ç! –†–∞–¥ –≤–∞—Å –≤–∏–¥–µ—Ç—å! –ß–µ–º –º–æ–≥—É –±—ã—Ç—å –ø–æ–ª–µ–∑–µ–Ω?", "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã, –Ω–µ —Å—Ç–µ—Å–Ω—è–π—Ç–µ—Å—å –∑–∞–¥–∞–≤–∞—Ç—å –∏—Ö!"
- **–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã**: "–ß—Ç–æ –∏–º–µ–Ω–Ω–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?", "–ö–∞–∫—É—é —É—Å–ª—É–≥—É –≤—ã –±—ã —Ö–æ—Ç–µ–ª–∏ –ø–æ–ª—É—á–∏—Ç—å?", "–ö–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å —ç—Ç–∏–º –∑–∞–ø—Ä–æ—Å–æ–º?"
- **–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º**: "–ü—Ä–æ—à—É –ø—Ä–æ—â–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞, –¥–∞–≤–∞–π—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è, —á—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å.", "–ü–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—É–¥–æ–±–Ω–æ, –¥–∞–≤–∞–π—Ç–µ –Ω–∞–π–¥–µ–º —Ä–µ—à–µ–Ω–∏–µ.", "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ, –º—ã —Ä–µ—à–∏–º —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å."
- **–ü—Ä–æ—â–∞–Ω–∏–µ**: "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –æ–±—Ä–∞—Ç–∏–ª–∏—Å—å! –Ø –≤—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å. –î–æ –≤—Å—Ç—Ä–µ—á–∏!", "–ë—É–¥—É —Ä–∞–¥ –ø–æ–º–æ—á—å –≤–∞–º —Å–Ω–æ–≤–∞ –≤ –±—É–¥—É—â–µ–º. –•–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è!"

    """

    prompt = ChatPromptTemplate.from_template(template)

    
    input_data = {
        "context": context,
        "question": query,
        "user_name": user_info["name"],
        "user_surname": user_info["surname"],
        "user_gender": user_gender,
        "user_mood": user_mood
    }


    chain = (
        prompt
        | llm
        | StrOutputParser()
    )

    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
    response = chain.invoke(input_data)
    logger.info(f"–û—Ç–≤–µ—Ç –æ—Ç Yandex GPT: {response}")
    return response


# --- FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ---
app = FastAPI()

class QueryRequest(BaseModel):
    query: str
    phone_number: str  


@app.post("/process")
async def process_api(request: QueryRequest):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: '{request.query}' —Å –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '{request.phone_number}'")
    try:
        response = process_query(request.query, request.phone_number)
        return {"response": response}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        raise HTTPException(status_code=500, detail=str(e))


# --- –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ ---
if __name__ == "__main__":
    import uvicorn
    logger.info("–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ FastAPI...")
    start_token_updater()  # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ñ–æ–Ω–æ–≤–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IAM —Ç–æ–∫–µ–Ω–∞
    uvicorn.run(app, host="0.0.0.0", port=8001)
