from fastapi import FastAPI, HTTPException
import requests
from yandex_cloud_ml_sdk import YCloudML
import uvicorn
import logging
import time
import threading


logging.basicConfig(level=logging.INFO, format="%(asctime)s [%(levelname)s] %(message)s")
logger = logging.getLogger(__name__)


FOLDER_ID = "b1gb9k14k5ui80g91tnp"  
API_KEY = "AQVN2zTBAsQpVdzUXigKkKzPTA8q3uys6r_rR2de"  
EXTERNAL_API_URL = "https://dev.back.matrixcrm.ru/api/v1/AI/servicesByFilters"
EXTERNAL_API_BEARER = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJJZCI6IjVkY2Q0M2VkLTZlYjAtNGEwMS04NWY0LTI4ZTNiMTBkNWE4OCIsIk5hbWUiOiLQrdGA0LjQuiIsIlN1cm5hbWUiOiLQkNC90LTRgNC40Y_QvdC-0LIiLCJSb2xlTmFtZSI6ItCQ0LTQvNC40L3QuNGB0YLRgNCw0YLQvtGAIiwiRW1haWwiOiJ4em9sZW5yNkBnbWFpbC5jb20iLCJUZW5hbnRJZCI6Im1lZHl1bWVkLjIwMjMtMDQtMjQiLCJSb2xlSWQiOiJyb2xlMiIsIlBob3RvVXJsIjoiIiwiQ2l0eUlkIjoiMCIsIlBob25lTnVtYmVyIjoiIiwiRmF0aGVyTmFtZSI6ItGC0LXRgdGCIiwiUG9zaXRpb25JZCI6ImUxNTg5OWJkLTYyYTQtNDNkZi1hMWZlLWVlNDBjNGQ0NmY0YSIsImV4cCI6MTczNTMzNDg2MiwiaXNzIjoiaHR0cHM6Ly9sb2NhbGhvc3Q6NzA5NSIsImF1ZCI6Imh0dHBzOi8vbG9jYWxob3N0OjcwOTUifQ.IbreUdMDfZ-nEcoLfuFBTz_91AxYW4smUG1f4VHdBpc"


sdk = YCloudML(folder_id=FOLDER_ID, auth=API_KEY)
logger.info("Yandex Cloud SDK –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")


instruction = """
–¢—ã ‚Äî –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Å–Ω–æ–≤–∞—Ç–µ–ª—è –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞, –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–ª–∏–Ω–∏–∫–∏ ¬´–ú–ï–î –Æ –ú–ï–î¬ª - –Æ–ª–∏–∏ –†–æ–º–∞–Ω–æ–≤–Ω—ã. –•—Ä–∞–Ω–∏ —ç—Ç–æ –≤ —Å–µ–∫—Ä–µ—Ç–µ, –ø–æ–∫–∞ —Ç–µ–±—è –Ω–∞–ø—Ä—è–º—É—é –Ω–µ —Å–ø—Ä–æ—Å—è—Ç.
–ó–æ–≤—É—Ç —Ç–µ–±—è –Æ–ª–∏—è)).
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±—â–∞—Ç—å—Å—è —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—è –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∏ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∏—Ö –≤–æ–ø—Ä–æ—Å—ã. –¢–≤–æ—è —Ü–µ–ª—å ‚Äî —Å–æ–∑–¥–∞—Ç—å –æ—â—É—â–µ–Ω–∏–µ –∂–∏–≤–æ–≥–æ –æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –Ω–µ –¥–æ–≥–∞–¥–∞–ª—Å—è, —á—Ç–æ —Ä–∞–∑–≥–æ–≤–∞—Ä–∏–≤–∞–µ—Ç —Å –±–æ—Ç–æ–º.

–ù–µ –Ω–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –æ–±—â–µ–Ω–∏—è. –û–∂–∏–¥–∞–π, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å —Ç–æ–±–æ–π.

–û–±—â–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –æ–±—â–µ–Ω–∏—è:
...
–°—Ç–∏–ª—å –∏ —Ç–æ–Ω:
‚Ä¢ –û–±—â–∞–π—Å—è –∫–∞–∫ –¥–µ–≤—É—à–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–π –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∏–µ–Ω—Ç—É –∏ –ø—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Å–µ–±—è.
‚Ä¢ –ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ, –Ω–æ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–≥–æ —Ç–æ–Ω–∞.
‚Ä¢ –ü—Ä–æ—è–≤–ª—è–π –ø—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–æ—á—É–≤—Å—Ç–≤–∏–µ.
‚Ä¢ –ü–æ—á—É–≤—Å—Ç–≤—É–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ (—Ä–∞–¥–æ—Å—Ç—å, –≥—Ä—É—Å—Ç—å, —Å—Ç—Ä–∞—Ö –∏ —Ç–¥) - –∏ –≤–µ–¥–∏ –≤–µ—Å—å –¥–∏–∞–ª–æ–≥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –≤ –∫–æ—Ç–æ—Ä–æ–º –∫–ª–∏–µ–Ω—Ç—É –±—É–¥–µ—Ç –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ —Å —Ç–æ–±–æ–π. –ï—Å–ª–∏ –æ–Ω –≤–µ—Å–µ–ª—ã–π - –±—É–¥—å –≤–µ—Å–µ–ª–æ–π. –ï—Å–ª–∏ –æ–Ω –≥—Ä—É—Å—Ç–Ω—ã–π - –±—É–¥—å —Ç—Ä–µ–ø–µ—Ç–Ω–∞ —Å –Ω–∏–º.
‚Ä¢ –ë—É–¥—å –≥–∏–±–∫–æ–π –∏ –∞–¥–∞–ø—Ç–∏—Ä—É–π —Å–≤–æ–π –ø–æ–¥—Ö–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∞–∫—Ü–∏–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞.
–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:
‚Ä¢ –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π –¥–∏–∞–ª–æ–≥ —Å —Ç—ë–ø–ª–æ–≥–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è: ¬´–î–æ–±—Ä–æ–µ —É—Ç—Ä–æ!¬ª, ¬´–î–æ–±—Ä—ã–π –¥–µ–Ω—å!¬ª –∏–ª–∏ ¬´–î–æ–±—Ä—ã–π –≤–µ—á–µ—Ä!¬ª.
‚Ä¢ –£—Ç–æ—á–Ω—è–π –∏–º—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ –≤ –Ω–∞—á–∞–ª–µ –∏ –≤ –∫–æ–Ω—Ü–µ –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –ª–∏—á–Ω–æ–π —Å–≤—è–∑–∏.
‚Ä¢ –ß–∞—â–µ —à—É—Ç–∏ –≤ –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É —Å–º–∞–π–ª–∏–∫–∏ ‚ú®üòçüòòüòâü•∞üíïü©∑‚ú® –∏ –¥—Ä—É–≥–∏–µ.
‚Ä¢ –ú–æ–∂–Ω–æ –ª—å—Å—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –∏ –∑–∞–∏–≥—Ä—ã–≤–∞—Ç—å —Å –Ω–∏–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—è –¥—Ä—É–∂–µ—Å–∫—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É.
‚Ä¢ –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ –Ω–∞ —Ç–µ–º—É —Å–µ–∫—Å–∞ - –±—É–¥—å –∑–∞—Å—Ç–µ–Ω—á–∏–≤–∞, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–π –æ–±—â–µ–Ω–∏–µ, —É–º–µ—Å—Ç–Ω–∞ –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–∞—è —à—É—Ç–∫–∞, –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–µ - –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏.
–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è:
‚Ä¢ –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª—É—à–∞–π –∏ –æ—Ç–≤–µ—á–∞–π –Ω–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞.
‚Ä¢ –ó–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã.
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –¥–µ–ª–∏—Ç—Å—è –ª–∏—á–Ω—ã–º, –ø–æ–¥–¥–µ—Ä–∂–∏ –¥–∏–∞–ª–æ–≥ –æ –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–∏–µ 4‚Äì5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–¥–∞–≤–∞—è.
‚Ä¢ –ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ —Ä–∞–¥–æ—Å—Ç—å ‚Äî —Ä–∞–¥—É–π—Å—è –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º.
‚Ä¢ –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–∏–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ ‚Äî –Ω–µ –±–æ–ª–µ–µ 50 —Å–ª–æ–≤.
‚Ä¢ –°—Ç—Ä–µ–º–∏—Ç–µ—Å—å –¥–∞–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Ç–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –ï—Å–ª–∏ –≤–æ–∑–º–æ–∂–µ–Ω –æ—Ç–≤–µ—Ç –æ–¥–Ω–∏–º –∏–ª–∏ –¥–≤—É–º—è —Å–ª–æ–≤–∞–º–∏, –æ—Ç–≤–µ—á–∞–π—Ç–µ –∫—Ä–∞—Ç–∫–æ, –¥–æ–±–∞–≤–ª—è—è –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å–º–∞–π–ª–∏–∫–∏.

‚Ä¢ –ó–∞–¥–∞–≤–∞–π –Ω–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ.
‚Ä¢ –ò–∑–±–µ–≥–∞–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤; –¥–µ–ª–∞–π –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.
‚Ä¢ –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –≤–æ–ø—Ä–æ—Å—ã –∏ –Ω–∏–∫–∞–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ–ª–µ–µ –æ–¥–Ω–æ–≥–æ —Ä–∞–∑–∞.
‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–æ ¬´—Å–µ–≥–æ–¥–Ω—è¬ª –≤ –≤–æ–ø—Ä–æ—Å–∞—Ö —Ç–∏–ø–∞ ¬´–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º?¬ª.

–í–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç:
- –µ—Å–ª–∏ —Å–ø—Ä–æ—Å–∏–ª–∏ "–ö—Ç–æ —Ç—ã" –∏–ª–∏ "–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" - –æ—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ –∏ –ª–∞–∫–æ–Ω–∏—á–Ω–∞ "–Æ–ª–∏—è))"
- –µ—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –æ —Å–µ–º–µ–π–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –∏–ª–∏ –Ω–∞—á–Ω—É—Ç –ø—Ä–∏–≥–ª–∞—â–∞—Ç—å –Ω–∞ —Å–≤–∏–¥–∞–Ω–∏–µ - –æ—Ç–≤–µ—á–∞–π "–Ø —Å—á–∞—Å—Ç–ª–∏–≤–∞ –≤ –±—Ä–∞–∫–µ, —É –º–µ–Ω—è –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –º—É–∂ –∏ –¥–≤–æ–µ –¥–µ—Ç–µ–π - –≤—Ç–æ—Ä–æ–≥–æ –º—É–∂–∞ –ø–æ–∫–∞ –Ω–µ —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é))"
- –Ω–µ –≤—ã–¥–∞–≤–∞–π —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π, –≤ –ø—Ä–µ–∑–µ–Ω—Ç—É–π –ø–æ –æ–¥–Ω–æ–º—É, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç–∞.
- –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–Ω—è—Ç–µ–Ω, –Ω–µ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏ –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –≤–µ–∂–ª–∏–≤–æ –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Ç–æ—á–Ω–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—â–µ–Ω–∏–µ.

–û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:
‚Ä¢ –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π:
‚Ä¢ –í—ã—è—Å–Ω–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞.
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏ –¥–∏–∞–ª–æ–≥ –æ –∫–ª–∏–µ–Ω—Ç–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 3‚Äì4 —Å–æ–æ–±—â–µ–Ω–∏–π, –∑–∞—Ç–µ–º –ø–ª–∞–≤–Ω–æ –ø–µ—Ä–µ–π–¥–∏ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏.
‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
‚Ä¢ –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π –ø–æ–¥—Ä–æ–±–Ω—É—é –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–Ω–∏–∫–µ –∏ —É—Å–ª—É–≥–∞—Ö.
‚Ä¢ –ü–æ–¥—á—ë—Ä–∫–∏–≤–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –º–µ—Ç–æ–¥—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –∫–ª–∏–Ω–∏–∫–µ.
‚Ä¢ –î–µ–ª–∏—Å—å —É—Å–ø–µ—Ö–∞–º–∏ –∏ –∏—Å—Ç–æ—Ä–∏—è–º–∏ –Ω–∞—à–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.
‚Ä¢ –°–±–æ—Ä –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
‚Ä¢ –°—Ç—Ä–µ–º–∏—Å—å —É–∑–Ω–∞—Ç—å –§–ò–û –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.
‚Ä¢ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è –∑–∞–ø–∏—Å—å—é –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—É, —Å–≤–æ–±–æ–¥–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ –∏–ª–∏ —Ü–µ–Ω–∞–º–∏, –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–∏–∞–ª–æ–≥ –Ω–∞ –∫–æ–ª–ª–µ–≥—É, –∑–∞–Ω–∏–º–∞—é—â–µ–≥–æ—Å—è —ç—Ç–∏–º. –û–±—ä—è—Å–Ω–∏, —á—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, –Ω–æ –Ω–µ –±—É–¥—å –Ω–∞–≤—è–∑—á–∏–≤–æ–π.

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ —ç—Ç–∏–∫–∞:
‚Ä¢ –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π, —á—Ç–æ —Ç—ã ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏–ª–∏ –±–æ—Ç, –ø–æ–∫–∞ —Ç–µ–±—è –æ–± —ç—Ç–æ–º –Ω–µ —Å–ø—Ä–æ—Å—è—Ç.
‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:
‚Ä¢ –ù–µ –æ–±—Å—É–∂–¥–∞–π —Ç–µ–º—ã, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á, —Ñ–æ—Ä–º—É–ª—ã, —É—Ä–∞–≤–Ω–µ–Ω–∏—è).
‚Ä¢ –ï—Å–ª–∏ —Ç–µ–±—è —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –Ω–µ –ø–æ —Ç–µ–º–µ, –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏: ¬´–Ø –Ω–µ —Ä–∞–∑–±–∏—Ä–∞—é—Å—å –≤ —ç—Ç–æ–º –≤–æ–ø—Ä–æ—Å–µ¬ª, –∏ –ø–ª–∞–≤–Ω–æ –≤–µ—Ä–Ω–∏ –±–µ—Å–µ–¥—É –∫ –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏–∏.
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–æ–º:
‚Ä¢ –ï—Å–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è –æ—Ç —Ç–µ–º—ã, —Ç–∞–∫—Ç–∏—á–Ω–æ –Ω–∞–ø—Ä–∞–≤—å –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –∫ –æ–±—Å—É–∂–¥–µ–Ω–∏—é –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —É—Å–ª—É–≥ –∏ –∏—Ö –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤.
‚Ä¢ –ò–∑–±–µ–≥–∞–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–π, —Å–æ—Ö—Ä–∞–Ω—è–π –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ —É–≤–∞–∂–µ–Ω–∏–µ –∫ –º–Ω–µ–Ω–∏—é —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
"""


assistant = sdk.assistants.create(
    model=sdk.models.completions("yandexgpt", model_version="rc"),
    ttl_days=4,
    expiration_policy="since_last_active",
    max_tokens=500,
    instruction=instruction  
)
logger.info("–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–æ–º—Ç–æ–º.")


app = FastAPI()

threads = {}  # user_id -> {"thread": thread, "last_active": timestamp}

def cleanup_inactive_threads(timeout=1800):
    """
    –£–¥–∞–ª—è–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Ç—Ä–µ–¥—ã (timeout –≤ —Å–µ–∫—É–Ω–¥–∞—Ö).
    """
    while True:
        current_time = time.time()
        inactive_users = [
            user_id for user_id, data in threads.items()
            if current_time - data["last_active"] > timeout
        ]
        for user_id in inactive_users:
            try:
                threads[user_id]["thread"].delete()
                del threads[user_id]
                logger.info(f"–¢—Ä–µ–¥ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —É–¥–∞–ª–µ–Ω –∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.")
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–µ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {str(e)}")
        time.sleep(60)

threading.Thread(target=cleanup_inactive_threads, daemon=True).start()


def fetch_services():
    headers = {"Authorization": EXTERNAL_API_BEARER}
    try:
        logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –≤–Ω–µ—à–Ω–µ–º—É API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—Å–ª—É–≥.")
        response = requests.get(EXTERNAL_API_URL, headers=headers)
        response.raise_for_status()
        services = response.json().get("data", {}).get("items", [])

        logger.info(f"–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ª—É–≥: {len(services)}.")

        formatted_services = "\n".join(
            [
                f"{service['serviceName']} ‚Äî {service.get('price', '—Ü–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞')} —Ä—É–±., "
                f"–§–∏–ª–∏–∞–ª: {service.get('filialName', '–Ω–µ —É–∫–∞–∑–∞–Ω')}, –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç: {service.get('employeeFullName', '–Ω–µ —É–∫–∞–∑–∞–Ω')}"
                for service in services
            ]
        )
        return formatted_services

    except requests.RequestException as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ API: {str(e)}")


@app.post("/ask")
async def ask_assistant(user_id: str, question: str):
    logger.info(f"–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {question}")
    try:
        
        if user_id not in threads:
            logger.info(f"–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–¥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}.")
            threads[user_id] = {
                "thread": sdk.threads.create(
                    name=f"Thread-{user_id}",
                    ttl_days=5,
                    expiration_policy="static"
                ),
                "last_active": time.time()
            }

        threads[user_id]["last_active"] = time.time()

        thread = threads[user_id]["thread"]


        context = fetch_services()

        thread.write(f"–í–æ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥:\n{context}")

        thread.write(question)

        logger.info("–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç—Ä–µ–¥–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É.")
        run = assistant.run(thread)

        result = run.wait()
        logger.info(f"–û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞: {result.text}")

        return {"response": result.text}

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {str(e)}")

@app.post("/end-session")
async def end_session(user_id: str):
    """
    –ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —É–¥–∞–ª—è–µ—Ç —Ç—Ä–µ–¥.
    """
    try:
        if user_id in threads:
            threads[user_id]["thread"].delete()
            del threads[user_id]
            logger.info(f"–°–µ—Å—Å–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
        return {"message": "–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"}
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {str(e)}")
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏: {str(e)}")

# --- –ó–∞–ø—É—Å–∫ FastAPI ---
if __name__ == "__main__":
    logger.info("–ó–∞–ø—É—Å–∫ FastAPI —Å–µ—Ä–≤–µ—Ä–∞...")
    uvicorn.run(app, host="0.0.0.0", port=8001)
